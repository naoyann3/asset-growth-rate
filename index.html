<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>主要資産 円建てパフォーマンス（積立シミュレーション追加版）</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #0f172a; -webkit-tap-highlight-color: transparent; }
  .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); padding: 20px; border: 1px solid #f1f5f9; }
  
  .ranking-scroll::-webkit-scrollbar { width: 4px; }
  .ranking-scroll::-webkit-scrollbar-track { background: transparent; }
  .ranking-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

  .asset-checkbox:checked + div { background-color: #f1f5f9; border-color: currentColor; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }
  
  .period-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); touch-action: manipulation; }
  .period-btn.active { background-color: #0f172a; color: white; border-color: #0f172a; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3); }
  
  .ranking-item { transition: transform 0.2s ease, background-color 0.2s; cursor: pointer; border-left: 4px solid transparent; }
  .ranking-item:hover { transform: translateX(4px); background-color: #f8fafc; }
  .ranking-item.active-highlight { background-color: #f1f5f9; border-left-color: currentColor; }

  details > summary { list-style: none; cursor: pointer; }
  details > summary::-webkit-details-marker { display: none; }

  .scroll-fade-right {
    mask-image: linear-gradient(to right, black 90%, transparent 100%);
    -webkit-mask-image: linear-gradient(to right, black 90%, transparent 100%);
  }
  
  .simulation-result-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
  }
  .simulation-result-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05);
  }
</style>
</head>
<body class="p-3 md:p-8 max-w-[1600px] mx-auto bg-slate-50 pb-20">

  <header class="mb-6 md:mb-10 text-center md:text-left md:flex md:justify-between md:items-end border-b border-slate-200 pb-4 md:pb-6">
    <div>
      <h1 class="text-2xl md:text-4xl font-extrabold text-slate-900 tracking-tight mb-2">
        主要資産パフォーマンス推移
      </h1>
      <div class="flex flex-col items-center md:items-start gap-1">
        <p class="text-slate-500 font-medium flex flex-col md:flex-row items-center md:items-start justify-center md:justify-start gap-1 md:gap-2 text-xs md:text-sm">
          <span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-[10px] md:text-xs font-bold">円建て換算</span>
          <span>2021.01 - 2025.11 (株式分割調整済み)</span>
        </p>
        <p class="text-slate-400 text-[10px] md:text-xs">
          ※算出基準：各月終値（金・銀は月次平均価格）
        </p>
      </div>
    </div>
    <div class="mt-2 md:mt-0 text-right hidden md:block">
      <div class="text-[10px] text-slate-400 font-mono tracking-widest uppercase mb-1">最終更新日</div>
      <div class="text-xl font-bold text-slate-700 font-mono">2025.12.03</div>
    </div>
  </header>

  <div class="mb-6">
    <div class="overflow-x-auto pb-2 -mx-3 px-3 md:mx-0 md:px-0 md:overflow-visible scroll-fade-right">
      <div class="flex md:flex-wrap gap-2 md:gap-4 min-w-max md:min-w-0">
        <button class="period-btn active px-4 py-2 rounded-full border border-slate-200 font-bold text-xs md:text-sm whitespace-nowrap" data-period="all">全期間</button>
        <button class="period-btn px-4 py-2 rounded-full border border-slate-200 font-bold text-xs md:text-sm whitespace-nowrap" data-period="2021">2021年〜</button>
        <button class="period-btn px-4 py-2 rounded-full border border-slate-200 font-bold text-xs md:text-sm whitespace-nowrap" data-period="2022">2022年〜</button>
        <button class="period-btn px-4 py-2 rounded-full border border-slate-200 font-bold text-xs md:text-sm whitespace-nowrap" data-period="2023">2023年〜</button>
        <button class="period-btn px-4 py-2 rounded-full border border-slate-200 font-bold text-xs md:text-sm whitespace-nowrap" data-period="2024">2024年〜</button>
        <button class="period-btn px-4 py-2 rounded-full border border-slate-200 font-bold text-xs md:text-sm whitespace-nowrap" data-period="2025">2025年〜</button>
      </div>
    </div>
    <p class="text-[10px] text-slate-400 text-center md:hidden mt-1 opacity-80">
      ← 横スクロールで期間を選択できます →
    </p>
  </div>

  <div class="flex flex-col lg:grid lg:grid-cols-4 gap-6">
    
    <div class="lg:col-span-3 order-1 space-y-6">
      <div class="card h-[55vh] md:h-[650px] relative p-1 md:p-6 w-full">
        <canvas id="chart"></canvas>
      </div>
      
      <div class="grid grid-cols-3 gap-2 md:gap-4">
        <div class="card bg-gradient-to-br from-indigo-50 to-white border border-indigo-100 flex flex-col justify-center py-2 md:py-4 px-2 md:px-6 text-center md:text-left">
          <div class="text-[8px] md:text-[10px] text-indigo-400 font-bold uppercase mb-1 tracking-wider">最高値 (Top)</div>
          <div class="flex flex-col md:flex-row items-center md:items-baseline gap-0 md:gap-2">
            <div class="text-sm md:text-2xl font-black text-indigo-900 truncate w-full" id="summary-best-name">-</div>
            <div class="text-[10px] md:text-sm font-bold text-indigo-600" id="summary-best-val">-</div>
          </div>
        </div>
        <div class="card bg-white border border-slate-100 flex flex-col justify-center py-2 md:py-4 px-2 md:px-6 text-center md:text-left">
          <div class="text-[8px] md:text-[10px] text-slate-400 font-bold uppercase mb-1 tracking-wider">平均 (Average)</div>
          <div class="text-sm md:text-2xl font-black text-slate-700" id="summary-avg">-</div>
        </div>
        <div class="card bg-white border border-slate-100 flex flex-col justify-center py-2 md:py-4 px-2 md:px-6 text-center md:text-left">
          <div class="text-[8px] md:text-[10px] text-slate-400 font-bold uppercase mb-1 tracking-wider">最下位 (Worst)</div>
          <div class="flex flex-col md:flex-row items-center md:items-baseline gap-0 md:gap-2">
             <div class="text-sm md:text-2xl font-black text-slate-700 truncate w-full" id="summary-worst-name">-</div>
             <div class="text-[10px] md:text-sm font-bold text-slate-500" id="summary-worst-val">-</div>
          </div>
        </div>
      </div>
      
      <!-- 積立投資シミュレーションセクション追加 -->
      <div class="card mt-6">
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-6 flex items-center">
          <span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded mr-2">NEW</span>
          積立投資シミュレーション
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">月々の積立額（円）</label>
            <input type="number" id="monthly-amount" value="20000" min="1000" step="1000" 
                   class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 font-medium">
            <p class="text-xs text-slate-500 mt-1">1,000円〜10,000,000円</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">積立開始年</label>
            <select id="start-year" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 font-medium">
              <option value="2021">2021年</option>
              <option value="2022" selected>2022年</option>
              <option value="2023">2023年</option>
              <option value="2024">2024年</option>
              <option value="2025">2025年</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">積立開始月</label>
            <select id="start-month" class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-slate-900 font-medium">
              <option value="01">1月</option>
              <option value="02">2月</option>
              <option value="03">3月</option>
              <option value="04">4月</option>
              <option value="05">5月</option>
              <option value="06">6月</option>
              <option value="07">7月</option>
              <option value="08">8月</option>
              <option value="09">9月</option>
              <option value="10" selected>10月</option>
              <option value="11">11月</option>
              <option value="12">12月</option>
            </select>
          </div>
          <div class="flex items-end">
            <button id="simulate-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200 flex items-center justify-center">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              シミュレーション実行
            </button>
          </div>
        </div>
        
        <div class="text-sm text-slate-600 mb-6 p-4 bg-slate-50 rounded-lg">
          <p class="font-medium mb-1">シミュレーションの仮定:</p>
          <ul class="list-disc pl-5 space-y-1 text-slate-500">
            <li>選択した開始月から毎月、指定した金額を積み立てます</li>
            <li>各月の終値（金・銀は平均価格）で購入したと仮定</li>
            <li>手数料・税金は考慮していません</li>
            <li>2025年11月末時点での評価額を計算</li>
          </ul>
        </div>
        
        <div id="simulation-results" class="space-y-4">
          <!-- シミュレーション結果がここに動的に追加されます -->
          <div class="text-center py-10 text-slate-400">
            <svg class="w-12 h-12 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <p class="font-medium">シミュレーション結果がここに表示されます</p>
            <p class="text-sm mt-1">上記の設定を入力して「シミュレーション実行」をクリックしてください</p>
          </div>
        </div>
      </div>
    </div>

    <div class="lg:col-span-1 space-y-6 order-2">
      
      <div class="card p-0 overflow-hidden">
        <details class="group" open>
          <summary class="flex justify-between items-center p-4 md:p-6 bg-white cursor-pointer hover:bg-slate-50 transition">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">表示銘柄の選択</h3>
            <span class="text-slate-400 group-open:rotate-180 transition-transform">▼</span>
          </summary>
          <div class="px-4 pb-4 md:px-6 md:pb-6 border-t border-slate-100 pt-4">
            <div class="flex justify-end gap-2 mb-3">
              <button id="btn-select-all" class="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full">全選択</button>
              <button id="btn-select-none" class="text-[10px] font-bold text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full">解除</button>
            </div>
            <div class="grid grid-cols-2 gap-2" id="asset-toggles"></div>
          </div>
        </details>
      </div>

      <div class="card h-[400px] lg:h-[calc(100vh-450px)] min-h-[300px] flex flex-col">
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex justify-between items-center">
          <span>騰落率ランキング</span>
          <span class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500" id="ranking-period-label">全期間</span>
        </h3>
        <div class="flex-1 overflow-y-auto ranking-scroll pr-1 space-y-1" id="ranking-list"></div>
      </div>
    </div>

  </div>

<script>
// =========================================================
//  データ定義 (2021/01 - 2025/11) : 円建て換算済み
// =========================================================

const db = {
  NVIDIA: [54414,58459,59122,65638,71218,88901,85507,98485,92207,116585,147705,135383,112713,112125,132813,97075,96569,82321,96793,83881,70283,80323,93394,76710,101691,126457,147575,151288,210857,244197,265901,287306,259842,247453,277341,279396,362371,474420,546828,545099,689869,795123,701595,697932,697330,807560,828210,844411,745395,752618,649878,622434,778561,910217,1072427,1030123,1103423,1246676,1105754],
  GOOGLE: [191372,215441,228380,257275,258311,271283,295508,318296,297511,337545,320717,333391,311438,310501,338443,298605,294300,295841,309923,300702,276907,281141,278672,231494,257242,245278,275548,292609,342347,345510,377556,396323,390808,376459,392965,393980,412544,415160,456846,513485,542593,586227,514220,477564,476063,500432,506039,595082,633278,512983,463640,453822,494749,507651,578416,629629,718843,865541,1000103],
  AAPL: [13819,12925,13526,14374,13657,15216,16000,16699,15745,17077,18681,20432,20113,18981,21250,20626,19215,18561,21650,21841,20005,22809,20423,17043,18776,20074,21891,23127,24697,28004,27944,27341,25568,25906,28159,27155,27156,27098,25945,26864,30233,33889,33284,33468,33456,34357,35545,39366,36627,36424,33300,30379,28931,29551,31283,34321,37644,41614,43551],
  NIKKEI: [27663,28966,29178,28813,28860,28792,27284,28090,29453,28893,27822,28792,27002,26527,27821,26848,27280,26393,27802,28092,25937,27587,27969,26095,27327,27446,28041,28856,30888,33189,33172,32619,31858,30859,33487,33464,36287,39166,40369,38406,38488,39583,39102,38648,37920,39081,38208,39895,39572,37156,35618,36045,37965,40487,41070,42718,44933,52411,50254],
  SP500: [13641,14043,15142,15861,15975,16444,16777,17277,16951,18163,18432,19204,17837,17684,19683,18851,18669,18301,19236,19417,18548,20365,19380,18035,18524,19213,19167,19670,20875,22664,22984,23519,22940,22238,23926,24281,26026,27391,28559,28832,29510,31789,29851,29198,29562,32262,32695,34182,33955,31801,30280,28788,30919,32527,34608,34812,36175,38371,38984],
  GOLD: [6276,6199,6066,6195,6549,6554,6450,6369,6368,6495,6728,6580,6755,6913,7464,7901,7695,7954,7699,7721,7794,7920,7944,7854,8024,7990,8249,8620,8822,8871,8879,8988,9155,9246,9604,9486,9622,9779,10428,11561,11880,11859,12185,11675,11863,12978,13155,13082,13676,14169,14298,14996,15349,15638,15832,16020,17429,19828,20454],
  SILVER: [89,96,93,93,100,99,95,88,86,88,92,85,89,90,99,103,93,96,87,89,89,94,98,103,102,97,96,109,109,109,111,112,113,110,116,115,111,112,120,138,151,153,155,138,141,159,157,154,156,160,162,153,156,170,181,184,205,243,257],
  BTC: [3467557,4813675,6507676,6310030,4088027,3891489,4557750,5183873,4875342,6989294,6428337,5319007,4430489,4964484,5540012,4925250,4091192,2705066,3103425,2785170,2811424,3048933,2368041,2169712,3009478,3149604,3779598,3987163,3792091,4397975,4159102,3774683,4026381,5256500,5591733,5961862,6269113,9170140,10792036,9569960,10622342,10096447,9686116,8620933,9095437,10688597,14438361,14707594,14672003,12710027,12374921,13463700,15066900,15436001,17446478,15999985,16864269,16870246,14114830],
  ETH: [137476,151211,212398,303131,296848,252624,277722,377347,333905,488782,523112,423246,309194,335941,399414,356876,249902,145130,223802,216084,192352,233969,178580,156913,206290,218527,241756,254729,261009,279091,264064,239522,249461,275355,304115,321830,336133,500617,552008,475446,591859,552999,484374,367390,373903,383111,554611,524639,511957,336839,273131,256403,364154,358133,557301,649540,612853,592238,467235],
  BNB: [4636,22386,33459,68154,38769,33691,36460,51067,43124,59788,70432,58888,43066,45475,52183,49322,41278,29780,37769,38784,41238,48460,41446,32288,40618,41041,42027,46011,42735,34695,34269,31535,32039,34329,33752,44005,44243,59834,91833,91223,93391,93700,86392,77882,81481,87694,97910,110416,105145,88591,90666,85733,94766,94614,118042,126812,149139,167566,136738]
};

const meta = {
  NVIDIA: { label:'NVIDIA', color:'#76B900', type:'stock' },
  GOOGLE: { label:'Google', color:'#4285F4', type:'stock' },
  AAPL:   { label:'Apple',  color:'#999999', type:'stock' },
  NIKKEI: { label:'日経平均', color:'#DC2626', type:'index' },
  SP500:  { label:'S&P 500',color:'#3B82F6', type:'index' },
  GOLD:   { label:'Gold',   color:'#D4AF37', type:'commodity' },
  SILVER: { label:'Silver', color:'#94A3B8', type:'commodity' },
  BTC:    { label:'Bitcoin',color:'#F7931A', type:'crypto' },
  ETH:    { label:'Ethereum',color:'#627EEA', type:'crypto' },
  BNB:    { label:'BNB',    color:'#F3BA2F', type:'crypto' }
};

const labels = [];
let startY = 2021, startM = 1;
for (let i = 0; i < 59; i++) {
  labels.push(`${startY}/${String(startM).padStart(2,'0')}`);
  startM++;
  if (startM > 12) { startM = 1; startY++; }
}

let myChart = null;
let currentPeriod = 'all';
let activeKeys = Object.keys(db);
let selectedAssetKey = null;

// =========================================================
//  積立投資シミュレーション関数
// =========================================================

// 積立シミュレーション計算関数
function calculateMonthlyInvestment(assetKey, monthlyAmount, startDate) {
  const data = db[assetKey];
  const startIndex = labels.indexOf(startDate);
  
  // 開始日がデータ範囲外の場合はnullを返す
  if (startIndex === -1 || startIndex >= data.length) return null;
  
  let totalUnits = 0; // 累計取得単位数
  let totalInvestment = 0; // 総投資額
  
  // 指定開始月から最終月まで積立計算
  for (let i = startIndex; i < data.length; i++) {
    const price = data[i]; // その月の価格
    const unitsBought = monthlyAmount / price; // その月に購入できる単位数
    totalUnits += unitsBought;
    totalInvestment += monthlyAmount;
  }
  
  const currentValue = totalUnits * data[data.length - 1]; // 現在の資産価値
  const profit = currentValue - totalInvestment; // 損益額
  const profitPercentage = (profit / totalInvestment) * 100; // 損益率
  
  // 積立回数（月数）の計算
  const investmentMonths = data.length - startIndex;
  
  return {
    totalInvestment,
    currentValue,
    profit,
    profitPercentage,
    totalUnits,
    finalPrice: data[data.length - 1],
    investmentMonths,
    assetKey
  };
}

// 全資産のシミュレーション実行
function runAllSimulations(monthlyAmount, startDate) {
  const results = {};
  
  // 現在選択されている資産のみを対象にする
  activeKeys.forEach(key => {
    const result = calculateMonthlyInvestment(key, monthlyAmount, startDate);
    if (result) {
      results[key] = {
        ...result,
        label: meta[key].label,
        color: meta[key].color
      };
    }
  });
  
  return results;
}

// シミュレーション結果を表示する関数
function displaySimulationResults(results) {
  const container = document.getElementById('simulation-results');
  container.innerHTML = '';
  
  if (Object.keys(results).length === 0) {
    container.innerHTML = `
      <div class="text-center py-10 text-slate-500">
        <p class="font-medium">選択された資産がありません</p>
        <p class="text-sm mt-1">左のパネルで資産を選択してください</p>
      </div>
    `;
    return;
  }
  
  // 結果を損益率でソート（高い順）
  const sortedResults = Object.entries(results).sort((a, b) => {
    return b[1].profitPercentage - a[1].profitPercentage;
  });
  
  // シミュレーション設定情報を表示
  const monthlyAmount = document.getElementById('monthly-amount').value;
  const startYear = document.getElementById('start-year').value;
  const startMonth = document.getElementById('start-month').value;
  
  const summaryCard = document.createElement('div');
  summaryCard.className = 'bg-indigo-50 border border-indigo-100 rounded-xl p-4 mb-6';
  summaryCard.innerHTML = `
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
      <div>
        <h4 class="font-bold text-slate-900 text-sm mb-1">シミュレーション設定</h4>
        <div class="flex flex-wrap gap-3 text-sm text-slate-600">
          <div class="flex items-center">
            <span class="font-medium">月々積立額:</span>
            <span class="ml-2 font-bold">¥${parseInt(monthlyAmount).toLocaleString()}</span>
          </div>
          <div class="flex items-center">
            <span class="font-medium">開始時期:</span>
            <span class="ml-2 font-bold">${startYear}年${parseInt(startMonth)}月</span>
          </div>
          <div class="flex items-center">
            <span class="font-medium">対象資産数:</span>
            <span class="ml-2 font-bold">${sortedResults.length}資産</span>
          </div>
        </div>
      </div>
      <button id="reset-simulation" class="mt-3 md:mt-0 text-xs font-bold text-indigo-600 bg-white px-3 py-2 rounded-lg border border-indigo-200 hover:bg-indigo-50 transition">
        設定をリセット
      </button>
    </div>
  `;
  container.appendChild(summaryCard);
  
  // リセットボタンのイベントリスナー
  document.getElementById('reset-simulation').addEventListener('click', function() {
    document.getElementById('monthly-amount').value = 20000;
    document.getElementById('start-year').value = '2022';
    document.getElementById('start-month').value = '10';
    container.innerHTML = `
      <div class="text-center py-10 text-slate-400">
        <svg class="w-12 h-12 mx-auto mb-3 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        <p class="font-medium">シミュレーション結果がここに表示されます</p>
        <p class="text-sm mt-1">上記の設定を入力して「シミュレーション実行」をクリックしてください</p>
      </div>
    `;
  });
  
  // 各資産の結果を表示
  sortedResults.forEach(([key, result], index) => {
    const card = document.createElement('div');
    card.className = `simulation-result-card p-5 border border-slate-200 rounded-xl bg-white ${result.profit >= 0 ? 'border-l-emerald-500' : 'border-l-rose-500'}`;
    card.style.borderLeftColor = result.color;
    card.innerHTML = `
      <div class="flex items-start justify-between mb-4">
        <div class="flex items-center">
          <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3" style="background-color:${result.color}">
            ${index + 1}
          </div>
          <div>
            <div class="flex items-center">
              <span class="font-bold text-slate-900 text-lg">${result.label}</span>
              <span class="ml-2 text-xs font-medium px-2 py-1 rounded-full ${result.profitPercentage >= 0 ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'}">
                ${result.profitPercentage >= 0 ? '+' : ''}${result.profitPercentage.toFixed(1)}%
              </span>
            </div>
            <div class="text-xs text-slate-500 mt-1">${result.investmentMonths}ヶ月間の積立</div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-xs text-slate-500">現在価値</div>
          <div class="font-black text-xl ${result.profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}">
            ¥${result.currentValue.toLocaleString()}
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-slate-50 p-3 rounded-lg">
          <div class="text-xs text-slate-500 mb-1">投資総額</div>
          <div class="font-bold text-slate-900">¥${result.totalInvestment.toLocaleString()}</div>
        </div>
        <div class="bg-slate-50 p-3 rounded-lg">
          <div class="text-xs text-slate-500 mb-1">損益額</div>
          <div class="font-bold ${result.profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}">
            ¥${result.profit >= 0 ? '+' : ''}${result.profit.toLocaleString()}
          </div>
        </div>
        <div class="bg-slate-50 p-3 rounded-lg">
          <div class="text-xs text-slate-500 mb-1">取得単位数</div>
          <div class="font-bold text-slate-900">${result.totalUnits.toFixed(4)}</div>
        </div>
      </div>
      
      <div class="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center text-sm">
        <div class="text-slate-600">
          <span class="font-medium">最終単価:</span> 
          <span class="font-bold ml-1">¥${result.finalPrice.toLocaleString()}</span>
        </div>
        <button class="text-indigo-600 font-medium hover:text-indigo-800 text-sm flex items-center simulation-detail-btn" data-asset="${key}">
          詳細を見る
          <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    `;
    
    container.appendChild(card);
  });
  
  // 詳細ボタンのイベントリスナー
  document.querySelectorAll('.simulation-detail-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const assetKey = this.getAttribute('data-asset');
      toggleAssetSelection(assetKey);
      
      // チャートエリアまでスクロール
      document.querySelector('.card.h-[55vh]').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
      });
    });
  });
}

// =========================================================
//  既存の関数（変更なし）
// =========================================================

function init() {
  createAssetToggles();
  setupEventListeners();
  renderChart();
  updateDashboard();
  setupSimulationListeners();
}

function createAssetToggles() {
  const container = document.getElementById('asset-toggles');
  Object.keys(meta).forEach(key => {
    const m = meta[key];
    const div = document.createElement('div');
    div.innerHTML = `
      <label class="cursor-pointer group block">
        <input type="checkbox" class="asset-checkbox hidden" value="${key}" checked>
        <div class="flex items-center p-2 rounded-lg border border-transparent transition-all hover:bg-white hover:shadow-sm" style="color:${m.color}">
          <span class="w-3 h-3 rounded-full mr-2" style="background-color:${m.color}"></span>
          <span class="font-bold text-sm text-slate-700 group-hover:text-slate-900">${m.label}</span>
        </div>
      </label>
    `;
    container.appendChild(div);
  });
}

function setupEventListeners() {
  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      currentPeriod = e.target.dataset.period;
      updateDashboard();
    });
  });

  document.querySelectorAll('.asset-checkbox').forEach(cb => {
    cb.addEventListener('change', () => {
      activeKeys = Array.from(document.querySelectorAll('.asset-checkbox:checked')).map(c => c.value);
      if (selectedAssetKey && !activeKeys.includes(selectedAssetKey)) {
        selectedAssetKey = null;
      }
      updateDashboard('none');
    });
  });

  document.getElementById('btn-select-all').addEventListener('click', () => {
    document.querySelectorAll('.asset-checkbox').forEach(c => c.checked = true);
    activeKeys = Object.keys(db);
    updateDashboard('none');
  });
  document.getElementById('btn-select-none').addEventListener('click', () => {
    document.querySelectorAll('.asset-checkbox').forEach(c => c.checked = false);
    activeKeys = [];
    selectedAssetKey = null;
    updateDashboard('none');
  });
  
  document.getElementById('chart').addEventListener('mouseleave', () => {
    if(!selectedAssetKey) updateDashboard('none'); 
  });
  
  if (window.innerWidth < 768) {
    document.querySelector('details').removeAttribute('open');
  }
}

function setupSimulationListeners() {
  const simulateBtn = document.getElementById('simulate-btn');
  
  if (simulateBtn) {
    simulateBtn.addEventListener('click', function() {
      const monthlyAmount = parseInt(document.getElementById('monthly-amount').value);
      const startYear = document.getElementById('start-year').value;
      const startMonth = document.getElementById('start-month').value;
      
      // 入力値のバリデーション
      if (!monthlyAmount || monthlyAmount < 1000 || monthlyAmount > 10000000) {
        alert('月々の積立額は1,000円〜10,000,000円の範囲で入力してください');
        return;
      }
      
      // 開始日のフォーマットを調整（例: "2021/01"）
      const startDate = `${startYear}/${startMonth}`;
      
      // 開始日がデータ範囲内か確認
      if (labels.indexOf(startDate) === -1 || labels.indexOf(startDate) >= labels.length) {
        alert('選択した開始日はデータ範囲外です。別の日付を選択してください。');
        return;
      }
      
      // シミュレーション実行
      const results = runAllSimulations(monthlyAmount, startDate);
      displaySimulationResults(results);
      
      // シミュレーション結果までスクロール
      document.getElementById('simulation-results').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
      });
    });
  }
  
  // Enterキーでシミュレーション実行
  document.getElementById('monthly-amount').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('simulate-btn').click();
    }
  });
}

function getStartIndex() {
  if (currentPeriod === 'all') return 0;
  const target = `${currentPeriod}/01`;
  return labels.indexOf(target);
}

function updateDashboard(mode = 'default') {
  const startIdx = getStartIndex();
  const slicedLabels = labels.slice(startIdx);
  
  const datasets = activeKeys.map(key => {
    const rawData = db[key].slice(startIdx);
    const baseValue = rawData[0];
    const percentageData = rawData.map(v => baseValue ? ((v - baseValue) / baseValue) * 100 : 0);
    
    const isSelected = selectedAssetKey === key;
    const isDimmed = selectedAssetKey !== null && !isSelected;

    return {
      label: meta[key].label,
      data: percentageData,
      rawValues: rawData,
      borderColor: isDimmed ? '#e2e8f0' : meta[key].color,
      backgroundColor: meta[key].color,
      borderWidth: isSelected ? 4 : (isDimmed ? 1 : 2),
      pointRadius: 0,
      tension: 0.1,
      assetKey: key,
      order: isSelected ? -1 : (isDimmed ? 1 : 0)
    };
  });

  myChart.data.labels = slicedLabels;
  myChart.data.datasets = datasets;
  myChart.update(mode);

  updateRankingAndSummary(activeKeys, startIdx);
  document.getElementById('ranking-period-label').textContent = document.querySelector('.period-btn.active').textContent;
}

function updateRankingAndSummary(keys, startIdx) {
  const rankingList = document.getElementById('ranking-list');
  rankingList.innerHTML = '';

  if (keys.length === 0) {
    document.getElementById('summary-best-name').textContent = '-';
    document.getElementById('summary-best-val').textContent = '-';
    document.getElementById('summary-avg').textContent = '-';
    document.getElementById('summary-worst-name').textContent = '-';
    document.getElementById('summary-worst-val').textContent = '-';
    return;
  }

  const performance = keys.map(key => {
    const data = db[key];
    const startVal = data[startIdx];
    const endVal = data[data.length - 1];
    const change = startVal ? ((endVal - startVal) / startVal) * 100 : 0;
    return { key, change, endVal, label: meta[key].label, color: meta[key].color };
  }).sort((a, b) => b.change - a.change);

  performance.forEach((item, index) => {
    const el = document.createElement('div');
    el.className = `ranking-item p-3 rounded-lg flex items-center justify-between mb-1 ${item.key === selectedAssetKey ? 'active-highlight' : ''}`;
    el.style.borderLeftColor = item.key === selectedAssetKey ? item.color : 'transparent';
    el.innerHTML = `
      <div class="flex items-center space-x-3">
        <span class="font-black text-slate-300 w-4 text-center">${index + 1}</span>
        <span class="font-bold text-sm text-slate-700" style="color:${item.color}">${item.label}</span>
      </div>
      <div class="text-right">
        <div class="font-black text-sm ${item.change > 0 ? 'text-emerald-500' : 'text-rose-500'}">
          ${item.change > 0 ? '+' : ''}${item.change.toFixed(1)}%
        </div>
        <div class="text-[10px] text-slate-400">¥${item.endVal.toLocaleString()}</div>
      </div>
    `;
    el.addEventListener('click', () => toggleAssetSelection(item.key));
    rankingList.appendChild(el);
  });

  const best = performance[0];
  const worst = performance[performance.length - 1];
  const avg = performance.reduce((sum, p) => sum + p.change, 0) / performance.length;

  document.getElementById('summary-best-name').textContent = best.label;
  document.getElementById('summary-best-name').style.color = best.color;
  document.getElementById('summary-best-val').textContent = `+${best.change.toFixed(1)}%`;
  
  document.getElementById('summary-worst-name').textContent = worst.label;
  document.getElementById('summary-worst-name').style.color = worst.color;
  document.getElementById('summary-worst-val').textContent = `${worst.change.toFixed(1)}%`;

  document.getElementById('summary-avg').textContent = `${avg > 0 ? '+' : ''}${avg.toFixed(1)}%`;
}

function toggleAssetSelection(key) {
  if (selectedAssetKey === key) {
    selectedAssetKey = null;
  } else {
    selectedAssetKey = key;
  }
  updateDashboard('none');
}

// --- PLUGIN: マイナス圏の背景色強調 (Darker) ---
const negativeZonePlugin = {
  id: 'negativeZone',
  beforeDraw: (chart) => {
    const { ctx, chartArea, scales } = chart;
    const yAxis = scales.y;
    
    const zeroPixel = yAxis.getPixelForValue(0);
    const bottomPixel = chartArea.bottom;
    const topPixel = chartArea.top;

    if (zeroPixel < bottomPixel) {
        const startY = Math.max(zeroPixel, topPixel);
        
        ctx.save();
        ctx.fillStyle = 'rgba(220, 38, 38, 0.15)'; 
        ctx.fillRect(chartArea.left, startY, chartArea.width, bottomPixel - startY);
        
        if (zeroPixel >= topPixel && zeroPixel <= bottomPixel) {
            ctx.beginPath();
            ctx.lineWidth = 1.5;
            ctx.strokeStyle = '#64748b'; 
            ctx.moveTo(chartArea.left, zeroPixel);
            ctx.lineTo(chartArea.right, zeroPixel);
            ctx.stroke();
        }
        ctx.restore();
    }
  }
};

// --- CUSTOM PLUGIN FOR SMART LABELS (Mobile対応) ---
const customLabelPlugin = {
  id: 'customSmartLabels',
  afterDatasetsDraw: (chart) => {
    const ctx = chart.ctx;
    const datasets = chart.data.datasets;
    const labelPoints = [];
    const isMobile = window.innerWidth < 768;

    datasets.forEach((ds, i) => {
      const meta = chart.getDatasetMeta(i);
      if (meta.hidden) return;

      const lastIndex = ds.data.length - 1;
      if (ds.data[lastIndex] === null || ds.data[lastIndex] === undefined) return;

      const view = meta.data[lastIndex];
      
      if (view) {
        let color = ds.borderColor;
        let bgColor = 'white';
        if (selectedAssetKey !== null && ds.assetKey !== selectedAssetKey) {
           color = '#cbd5e1'; 
           bgColor = '#f8fafc';
        }

        labelPoints.push({
          index: i,
          x: view.x,
          y: view.y,
          drawY: view.y,
          label: ds.label,
          color: color,
          bgColor: bgColor,
          assetKey: ds.assetKey
        });
      }
    });

    labelPoints.sort((a, b) => a.y - b.y);

    const spacing = 2; 
    const labelHeight = isMobile ? 16 : 24; 

    for (let i = 1; i < labelPoints.length; i++) {
        const prev = labelPoints[i - 1];
        const curr = labelPoints[i];
        if (curr.drawY < prev.drawY + labelHeight + spacing) {
            curr.drawY = prev.drawY + labelHeight + spacing;
        }
    }

    const bottomEdge = chart.chartArea.bottom;
    const last = labelPoints[labelPoints.length - 1];
    
    if (last && last.drawY + labelHeight / 2 > bottomEdge) {
        last.drawY = bottomEdge - labelHeight / 2;
        for (let i = labelPoints.length - 2; i >= 0; i--) {
            const next = labelPoints[i + 1];
            const curr = labelPoints[i];
            if (curr.drawY > next.drawY - labelHeight - spacing) {
                curr.drawY = next.drawY - labelHeight - spacing;
            }
        }
    }

    ctx.save();
    ctx.font = isMobile ? 'bold 9px "Inter", sans-serif' : 'bold 12px "Inter", sans-serif';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';

    const paddingX = isMobile ? 4 : 8;
    const paddingY = isMobile ? 2 : 4;
    const cornerRadius = 4;
    const labelXOffset = isMobile ? 5 : 20;

    labelPoints.forEach(p => {
      const textMetrics = ctx.measureText(p.label);
      const textWidth = textMetrics.width;
      const textHeight = isMobile ? 9 : 12;
      
      const boxX = chart.chartArea.right + labelXOffset;
      const boxY = p.drawY - (textHeight + paddingY * 2) / 2;
      const boxW = textWidth + paddingX * 2;
      const boxH = textHeight + paddingY * 2;

      ctx.beginPath();
      ctx.strokeStyle = p.color;
      ctx.lineWidth = 1;
      ctx.moveTo(p.x, p.y); 
      ctx.lineTo(chart.chartArea.right + 2, p.drawY);
      ctx.lineTo(boxX, p.drawY);
      ctx.stroke();

      ctx.fillStyle = p.bgColor;
      ctx.strokeStyle = p.color;
      ctx.lineWidth = 1.5;
      
      ctx.beginPath();
      const r = cornerRadius;
      ctx.moveTo(boxX + r, boxY);
      ctx.lineTo(boxX + boxW - r, boxY);
      ctx.quadraticCurveTo(boxX + boxW, boxY, boxX + boxW, boxY + r);
      ctx.lineTo(boxX + boxW, boxY + boxH - r);
      ctx.quadraticCurveTo(boxX + boxW, boxY + boxH, boxX + boxW - r, boxY + boxH);
      ctx.lineTo(boxX + r, boxY + boxH);
      ctx.quadraticCurveTo(boxX, boxY + boxH, boxX, boxY + boxH - r);
      ctx.lineTo(boxX, boxY + r);
      ctx.quadraticCurveTo(boxX, boxY, boxX + r, boxY);
      ctx.closePath();
      
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = p.color;
      ctx.fillText(p.label, boxX + paddingX, p.drawY);
    });

    ctx.restore();
  }
};

function renderChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  Chart.defaults.font.family = "'Inter', sans-serif";
  
  const isMobile = window.innerWidth < 768; 

  myChart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [] },
    plugins: [negativeZonePlugin, customLabelPlugin],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      hover: { mode: null }, 
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      },
      onClick: (e, activeElements, chart) => {
        if (activeElements.length > 0) {
          const index = activeElements[0].datasetIndex;
          const key = chart.data.datasets[index].assetKey;
          toggleAssetSelection(key);
        } else {
          selectedAssetKey = null;
          updateDashboard('none');
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: !isMobile,
          backgroundColor: 'rgba(255, 255, 255, 0.95)',
          titleColor: '#1e293b',
          bodyColor: '#334155',
          borderColor: '#e2e8f0',
          borderWidth: 1,
          padding: 10,
          titleFont: { weight: 'bold' },
          itemSort: function(a, b) { return b.raw - a.raw; },
          callbacks: {
            label: function(context) {
              const label = context.dataset.label || '';
              const val = context.parsed.y;
              const raw = context.dataset.rawValues[context.dataIndex];
              return `${label}: ${val > 0 ? '+' : ''}${val.toFixed(1)}% (¥${raw.toLocaleString()})`;
            }
          }
        },
        datalabels: { display: false }
      },
      layout: {
        padding: { right: window.innerWidth < 768 ? 80 : 140 } 
      },
      scales: {
        x: {
          grid: { 
            display: true, 
            color: '#e2e8f0',
            drawBorder: false
          },
          ticks: { 
            maxTicksLimit: window.innerWidth < 768 ? 6 : 12, 
            color: '#64748b', 
            font: { size: 11, weight: '500' }
          }
        },
        y: {
          grid: { color: '#f1f5f9' },
          ticks: { 
            callback: function(value) { return value + '%'; },
            color: '#94a3b8'
          }
        }
      }
    }
  });
}

// 初期化実行
init();
</script>
</body>
</html>
